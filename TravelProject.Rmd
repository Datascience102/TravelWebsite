---
title: "A Market Segmentation and Purchase Drivers Process"
author: "Alessandro Quintarelli, Marcelo Santiso, Oreste Gasparro"
output:
  html_document:
    css: ../../AnalyticsStyles/default.css
    theme: paper
    toc: yes
    toc_float:
      collapsed: no
      smooth_scroll: yes
  pdf_document:
    includes:
      in_header: ../../AnalyticsStyles/default.sty
always_allow_html: yes
---
```{r setuplibraries, echo=FALSE, message=FALSE}
source("Library/Library.R")
source("Library/allPublicLibraries.R")
source("Library/heatmapOutput.R")
source("Library/helpersSet1.R")
source("Library/helpersSet2.R")
source("Library/MatrixOperations.R")

ggthemr('fresh')  # ggplot theme
opts_knit$set(progress=FALSE, verbose=FALSE)
opts_chunk$set(echo=FALSE, fig.align="center", fig.width=10, fig.height=6.5)
options(knitr.kable.NA = '')

```
> 
# The Business Questions

Identify the main customer segments and define market strategies to increase revenues generated.

# The Process

The process we followed can be splitted in 3 different parts:

1. *Part 1*: We analyse the different attributes to find **key customer descriptors** using *dimensionality reduction* techniques 

2. *Part 2*: We use the selected customer descriptors to **segment the market** using *cluster analysis* techniques

3. *Part 3*: For the market segments we create, we will use *classification analysis* to classify people based on whether or not they have purchased a product and find what are the **key purchase drivers per segment**

Finally, we will use the results of this analysis to make business decisions about brand positioning depending on our market segments and key purchase drivers we find at the end of this process.


# The Data

First we load the data to use:

```{r setupdata1E, echo=TRUE, tidy=TRUE}
myData <- read.csv(file = "Data/Iberostar.csv", header = TRUE, sep=",")
MIN_VALUE = 0.5
max_data_report = 10
```
  
# Part 1: Key Customer Characteristics

```{r setupfactor, echo=TRUE, tidy=TRUE}
factor_attributes_used = c(1:19)
factor_selectionciterion = 
minimum_variance_explained = 65
manual_numb_factors_used = 5
rotation_used = "varimax"

```

```{r}
factor_attributes_used <- intersect(factor_attributes_used, 1:ncol(ProjectData))
ProjectDataFactor <- ProjectData[,factor_attributes_used]
ProjectDataFactor <- ProjectData <- data.matrix(ProjectDataFactor)
```

## Steps 1-2: Check the Data 

Start by some basic visual exploration of, say, a few data:

```{r}
rownames(ProjectDataFactor) <- paste0("Obs.", sprintf("%02i", 1:nrow(ProjectDataFactor)))
iprint.df(t(head(round(ProjectDataFactor, 2), max_data_report)))
```

The data we use here have the following descriptive statistics: 

```{r}
iprint.df(round(my_summary(ProjectDataFactor), 2))
```

## Step 3: Check Correlations

This is the correlation matrix of the customer responses to the `r ncol(ProjectDataFactor)` attitude questions - which are the only questions that we will use for the segmentation (see the case):

```{r}
thecor = round(cor(ProjectDataFactor),2)
iprint.df(round(thecor,2), scale=TRUE)
```

**Questions**

1. Do you see any high correlations between the responses? Do they make sense? 
2. What do these correlations imply?

**Answers:**

*
*
*
*
*
*
*
*
*
*

## Step 4: Choose number of factors

To use Factor Analysis, we first need to adjust data to have only numeric data. 
We can then remove first columns and keep only binary values.

```{r}
num_data <- myData[,4:ncol(myData)]
scaled_data <- apply(num_data,2, function(r) {if (sd(r)!=0) res=(r-mean(r))/sd(r) else res=0*r; res})
#scaled_data = data.frame(cbind(colnames(scaled_data), round(cor(scaled_data),2)))
```

Now that we have only numeric data, we can proceed with Factor Analysis.

```{r}
Variance_Explained_Table_results<-PCA(scaled_data, graph=FALSE)
Variance_Explained_Table<-Variance_Explained_Table_results$eig
#Variance_Explained_Table_copy<-Variance_Explained_Table
#row=1:nrow(Variance_Explained_Table)
#name<-paste("Component No:",row,sep="")
#Variance_Explained_Table<-cbind(name,Variance_Explained_Table)
Variance_Explained_Table<-as.data.frame(Variance_Explained_Table)
colnames(Variance_Explained_Table)<-c("Eigenvalue", "Percentage_of_explained_variance", "Cumulative_percentage_of_explained_variance")

eigenvalues  <- Variance_Explained_Table[,2]
```

Let's look at the **variance explained** as well as the **eigenvalues**

```{r}
iprint.df(round(Variance_Explained_Table, 2))
```

```{r}
eigenvalues  <- Variance_Explained_Table[, "Eigenvalue"]
df           <- cbind(as.data.frame(eigenvalues), c(1:length(eigenvalues)), rep(1, length(eigenvalues)))
colnames(df) <- c("eigenvalues", "components", "abline")
iplot.df(melt(df, id="components"))
```

## Step 5: Interpret the Components

We can see from the chart above that we could use only 8 components.
This can be easily explained looking at the variables. Some variables are binary values conveying the same meaning. 
We can identify the following groups:

* Device
* Returning/New Visitor
* Source
* Revenues
* Number of Sessions
* Number of pages visited
* Number of Users
* Number of Transactions

In this case we suggest to keep all the original variables since they are just a way to provide the same information in a binary form.

<hr>\clearpage

# Part 2: Marketing Strategy
